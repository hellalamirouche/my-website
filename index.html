
<html><head><base href="https://peer-chat.websim.ai/"><title>P2P Live Streaming Platform</title><style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f0f0f0;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  h1, h2 {
    color: #333;
  }
  #videoElement {
    width: 100%;
    background-color: #ddd;
  }
  .controls {
    margin-top: 20px;
  }
  button {
    padding: 10px 20px;
    margin-right: 10px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background-color: #45a049;
  }
  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }
  #viewerCount {
    font-size: 18px;
    font-weight: bold;
    margin-top: 20px;
  }
  #chatBox {
    height: 300px;
    border: 1px solid #ddd;
    overflow-y: scroll;
    padding: 10px;
    margin-top: 20px;
  }
  #chatInput {
    width: calc(100% - 110px);
    padding: 10px;
    margin-top: 10px;
  }
  #sendButton {
    width: 100px;
    margin-left: 10px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>P2P Live Streaming Platform</h1>
    <video id="videoElement" autoplay></video>
    <div class="controls">
      <button id="startButton">Start Stream</button>
      <button id="stopButton" disabled>Stop Stream</button>
      <button id="screenShareButton" disabled>Share Screen</button>
    </div>
    <div id="viewerCount">Viewers: 0</div>
    <h2>Live Chat</h2>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button id="sendButton">Send</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.2/peerjs.min.js"></script>
  <script>
    const videoElement = document.getElementById('videoElement');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const screenShareButton = document.getElementById('screenShareButton');
    const viewerCount = document.getElementById('viewerCount');
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');

    let peer;
    let stream;
    let connections = [];
    let isStreamer = false;

    // Initialize PeerJS
    function initPeer() {
      peer = new Peer();
      
      peer.on('open', (id) => {
        console.log('My peer ID is: ' + id);
        checkExistingStream();
      });

      peer.on('connection', (conn) => {
        connections.push(conn);
        updateViewerCount();
        setupDataConnection(conn);
      });

      peer.on('call', (call) => {
        if (!isStreamer) {
          call.answer(); // Answer the call with no stream
          call.on('stream', (remoteStream) => {
            videoElement.srcObject = remoteStream;
          });
        }
      });
    }

    function checkExistingStream() {
      // In a real application, you'd check with a server if a stream is already active
      // For this example, we'll use a hardcoded peer ID to simulate an existing stream
      const existingStreamerId = 'existing-streamer-id';
      
      peer.connect(existingStreamerId, { reliable: true })
        .on('open', () => {
          console.log('Connected to existing stream');
          disableStreamerControls();
        })
        .on('error', () => {
          console.log('No existing stream, you can start one');
          enableStreamerControls();
        });
    }

    function disableStreamerControls() {
      startButton.disabled = true;
      stopButton.disabled = true;
      screenShareButton.disabled = true;
    }

    function enableStreamerControls() {
      startButton.disabled = false;
      screenShareButton.disabled = false;
    }

    async function startStream() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        videoElement.srcObject = stream;
        isStreamer = true;
        startButton.disabled = true;
        stopButton.disabled = false;
        screenShareButton.disabled = false;
        
        broadcastStream();
      } catch (err) {
        console.error("Error accessing media devices:", err);
      }
    }

    function broadcastStream() {
      peer.on('connection', (conn) => {
        const call = peer.call(conn.peer, stream);
      });
    }

    function stopStream() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
        isStreamer = false;
        startButton.disabled = false;
        stopButton.disabled = true;
        screenShareButton.disabled = true;
        
        connections.forEach(conn => conn.close());
        connections = [];
        updateViewerCount();
      }
    }

    async function shareScreen() {
      try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        videoElement.srcObject = screenStream;
        
        if (isStreamer) {
          // Replace the video track in the existing stream
          const videoTrack = screenStream.getVideoTracks()[0];
          const sender = peer.getSenders().find(s => s.track.kind === 'video');
          sender.replaceTrack(videoTrack);
        }
      } catch (err) {
        console.error("Error sharing screen:", err);
      }
    }

    function setupDataConnection(conn) {
      conn.on('data', (data) => {
        if (data.type === 'chat') {
          addMessageToChat(conn.peer, data.message);
        }
      });

      conn.on('close', () => {
        connections = connections.filter(c => c !== conn);
        updateViewerCount();
      });
    }

    function sendChatMessage() {
      const message = chatInput.value.trim();
      if (message) {
        connections.forEach(conn => {
          conn.send({ type: 'chat', message: message });
        });
        addMessageToChat('You', message);
        chatInput.value = '';
      }
    }

    function addMessageToChat(sender, message) {
      const messageElement = document.createElement('p');
      messageElement.textContent = `${sender}: ${message}`;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateViewerCount() {
      viewerCount.textContent = `Viewers: ${connections.length}`;
    }

    startButton.addEventListener('click', startStream);
    stopButton.addEventListener('click', stopStream);
    screenShareButton.addEventListener('click', shareScreen);
    sendButton.addEventListener('click', sendChatMessage);

    // Initialize on page load
    initPeer();
  </script>
</body></html>
