
<html><head><base href="https://visio.ai/"><title>Visio AI - WebRTC Video Conferencing (Debug Mode)</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    height: 100%;
    overflow: hidden;
  }
  .container {
    display: flex;
    height: 100vh;
  }
  .sidebar {
    width: 300px;
    background-color: #f3f2f1;
    padding: 20px;
    overflow-y: auto;
  }
  .main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  .video-grid {
    flex-grow: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    padding: 20px;
    background-color: #2f2f2f;
    overflow-y: auto;
  }
  .video-container {
    background-color: #1f1f1f;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    position: relative;
  }
  .video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .controls {
    display: flex;
    justify-content: center;
    padding: 20px;
    background-color: #f3f2f1;
  }
  .control-btn {
    margin: 0 10px;
    padding: 10px 20px;
    background-color: #464775;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .control-btn:hover {
    background-color: #5c5c8a;
  }
  .participant {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background-color: #fff;
    border-radius: 5px;
  }
  .participant-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    background-color: #464775;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .participant-name {
    font-weight: bold;
  }
  #joinForm, #createForm {
    margin-bottom: 20px;
  }
  #joinForm input, #joinForm button, #createForm input, #createForm button {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
  }
  #joinForm button, #createForm button {
    background-color: #464775;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .waiting-message {
    text-align: center;
    color: #666;
    margin-top: 20px;
  }
  .name-label {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background-color: rgba(0,0,0,0.5);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
  }
  #roomInfo {
    margin-top: 20px;
    padding: 10px;
    background-color: #e6e6e6;
    border-radius: 5px;
    display: none;
  }
  #debugInfo {
    margin-top: 20px;
    padding: 10px;
    background-color: #ffe6e6;
    border-radius: 5px;
    font-family: monospace;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>Visio AI Conference (Debug)</h2>
    <div id="createForm">
      <input type="text" id="createNameInput" placeholder="Enter your name">
      <button onclick="createRoom()">Create New Room</button>
    </div>
    <div id="joinForm">
      <input type="text" id="joinNameInput" placeholder="Enter your name">
      <input type="text" id="roomInput" placeholder="Enter room ID">
      <button onclick="joinRoom()">Join Room</button>
    </div>
    <div id="roomInfo"></div>
    <h3>Participants</h3>
    <div id="participantsList"></div>
    <div id="debugInfo"></div>
  </div>
  <div class="main-content">
    <div id="videoGrid" class="video-grid">
      <div class="waiting-message">
        <h3>Welcome to Visio AI (Debug Mode)</h3>
        <p>Create a new room or join an existing one to start.</p>
      </div>
    </div>
    <div class="controls">
      <button class="control-btn" id="muteBtn">Mute</button>
      <button class="control-btn" id="videoBtn">Stop Video</button>
      <button class="control-btn" id="shareBtn">Share Screen</button>
      <button class="control-btn" id="leaveBtn">Leave Room</button>
    </div>
  </div>
</div>

<script>
  const participants = new Map();
  const videoGrid = document.getElementById('videoGrid');
  const participantsList = document.getElementById('participantsList');
  const createNameInput = document.getElementById('createNameInput');
  const joinNameInput = document.getElementById('joinNameInput');
  const roomInput = document.getElementById('roomInput');
  const roomInfo = document.getElementById('roomInfo');
  const debugInfo = document.getElementById('debugInfo');
  const muteBtn = document.getElementById('muteBtn');
  const videoBtn = document.getElementById('videoBtn');
  const shareBtn = document.getElementById('shareBtn');
  const leaveBtn = document.getElementById('leaveBtn');

  let localStream;
  let screenStream;
  let isAudioMuted = false;
  let isVideoStopped = false;
  let isScreenSharing = false;
  let roomId;
  let localPeerConnection;
  let localUuid;
  let socket;

  const configuration = {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
    ]
  };

  function log(message) {
    console.log(message);
    debugInfo.textContent += message + '\n';
    debugInfo.scrollTop = debugInfo.scrollHeight;
  }

  async function createRoom() {
    const name = createNameInput.value.trim();
    if (!name) {
      alert('Please enter your name');
      return;
    }
    roomId = generateRoomId();
    await initializeLocalStream(name);
    initializeWebSocket(roomId, name);
    updateRoomInfo();
  }

  async function joinRoom() {
    const name = joinNameInput.value.trim();
    roomId = roomInput.value.trim();
    if (!name || !roomId) {
      alert('Please enter your name and room ID');
      return;
    }
    await initializeLocalStream(name);
    initializeWebSocket(roomId, name);
    updateRoomInfo();
  }

  function generateRoomId() {
    return Math.random().toString(36).substring(2, 15);
  }

  async function initializeLocalStream(name) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localUuid = generateUuid();
      setupLocalVideo(name);
      log('Local stream initialized');
    } catch (error) {
      console.error('Error accessing media devices:', error);
      log('Error accessing media devices: ' + error.message);
      alert('Failed to access camera and microphone. Please ensure you have given the necessary permissions.');
    }
  }

  function initializeWebSocket(roomId, name) {
    socket = new WebSocket(`wss://visio.ai/room/${roomId}`);

    socket.onopen = () => {
      log('Connected to WebSocket server');
      socket.send(JSON.stringify({ type: 'join', name, uuid: localUuid }));
    };

    socket.onmessage = async (event) => {
      const message = JSON.parse(event.data);
      log('Received message: ' + JSON.stringify(message));
      switch (message.type) {
        case 'user-joined':
          if (message.uuid !== localUuid) {
            await createPeerConnection(message.uuid, message.name);
          }
          break;
        case 'user-left':
          removePeerConnection(message.uuid);
          break;
        case 'signal':
          handleSignalingData(message.uuid, message.data);
          break;
      }
    };

    socket.onerror = (error) => {
      console.error('WebSocket error:', error);
      log('WebSocket error: ' + error.message);
    };

    socket.onclose = () => {
      log('Disconnected from WebSocket server');
    };
  }

  async function createPeerConnection(remoteUuid, remoteName) {
    log('Creating peer connection for ' + remoteName);
    const peerConnection = new RTCPeerConnection(configuration);
    participants.set(remoteUuid, { peerConnection, name: remoteName });

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        log('Sending ICE candidate');
        sendSignalingData(remoteUuid, { type: 'ice-candidate', candidate: event.candidate });
      }
    };

    peerConnection.ontrack = (event) => {
      log('Received remote track');
      addVideoElement(remoteName, event.streams[0], remoteUuid);
    };

    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    try {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      log('Sending offer');
      sendSignalingData(remoteUuid, { type: 'offer', sdp: offer.sdp });
    } catch (error) {
      console.error('Error creating offer:', error);
      log('Error creating offer: ' + error.message);
    }

    updateParticipantsList();
  }

  function removePeerConnection(remoteUuid) {
    log('Removing peer connection for ' + remoteUuid);
    const participant = participants.get(remoteUuid);
    if (participant) {
      participant.peerConnection.close();
      participants.delete(remoteUuid);
      removeVideoElement(remoteUuid);
      updateParticipantsList();
    }
  }

  async function handleSignalingData(remoteUuid, data) {
    const participant = participants.get(remoteUuid);
    if (!participant) return;

    const { peerConnection } = participant;

    switch (data.type) {
      case 'offer':
        log('Received offer');
        await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        log('Sending answer');
        sendSignalingData(remoteUuid, { type: 'answer', sdp: answer.sdp });
        break;
      case 'answer':
        log('Received answer');
        await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
        break;
      case 'ice-candidate':
        log('Received ICE candidate');
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        break;
    }
  }

  function sendSignalingData(remoteUuid, data) {
    log('Sending signaling data: ' + JSON.stringify(data));
    socket.send(JSON.stringify({ type: 'signal', uuid: localUuid, remoteUuid, data }));
  }

  function setupLocalVideo(name) {
    addVideoElement(name, localStream, 'local');
    const localVideo = document.getElementById('video-local');
    if (localVideo) {
      localVideo.querySelector('video').muted = true;
    }
  }

  function addVideoElement(name, stream, uuid) {
    log('Adding video element for ' + name);
    const videoContainer = document.createElement('div');
    videoContainer.className = 'video-container';
    videoContainer.id = `video-${uuid}`;
    const video = document.createElement('video');
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    const nameLabel = document.createElement('div');
    nameLabel.className = 'name-label';
    nameLabel.textContent = name;
    videoContainer.appendChild(video);
    videoContainer.appendChild(nameLabel);
    videoGrid.appendChild(videoContainer);
  }

  function removeVideoElement(uuid) {
    log('Removing video element for ' + uuid);
    const videoElement = document.getElementById(`video-${uuid}`);
    if (videoElement) {
      videoElement.remove();
    }
  }

  function updateParticipantsList() {
    participantsList.innerHTML = '';
    participants.forEach((participant, uuid) => {
      const participantDiv = document.createElement('div');
      participantDiv.className = 'participant';
      participantDiv.innerHTML = `
        <div class="participant-avatar">${participant.name[0].toUpperCase()}</div>
        <span class="participant-name">${participant.name}</span>
      `;
      participantsList.appendChild(participantDiv);
    });
  }

  function updateRoomInfo() {
    roomInfo.style.display = 'block';
    roomInfo.innerHTML = `
      <strong>Room ID:</strong> ${roomId}<br>
      <strong>Your Name:</strong> ${createNameInput.value || joinNameInput.value}
    `;
  }

  muteBtn.addEventListener('click', () => {
    isAudioMuted = !isAudioMuted;
    localStream.getAudioTracks()[0].enabled = !isAudioMuted;
    muteBtn.textContent = isAudioMuted ? 'Unmute' : 'Mute';
    log('Audio ' + (isAudioMuted ? 'muted' : 'unmuted'));
  });

  videoBtn.addEventListener('click', () => {
    isVideoStopped = !isVideoStopped;
    localStream.getVideoTracks()[0].enabled = !isVideoStopped;
    videoBtn.textContent = isVideoStopped ? 'Start Video' : 'Stop Video';
    log('Video ' + (isVideoStopped ? 'stopped' : 'started'));
  });

  shareBtn.addEventListener('click', async () => {
    if (!isScreenSharing) {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const videoTrack = screenStream.getVideoTracks()[0];
        replaceVideoTrack(videoTrack);
        isScreenSharing = true;
        shareBtn.textContent = 'Stop Sharing';
        videoTrack.onended = stopScreenSharing;
        log('Screen sharing started');
      } catch (error) {
        console.error('Error sharing screen:', error);
        log('Error sharing screen: ' + error.message);
        alert('Failed toshare screen. Please ensure you have given the necessary permissions.');
      }
    } else {
      stopScreenSharing();
    }
  });

  function replaceVideoTrack(newTrack) {
    participants.forEach((participant) => {
      const videoSender = participant.peerConnection.getSenders().find(sender => sender.track.kind === 'video');
      if (videoSender) {
        videoSender.replaceTrack(newTrack);
      }
    });
    document.getElementById('video-local').querySelector('video').srcObject = new MediaStream([newTrack]);
    log('Video track replaced');
  }

  function stopScreenSharing() {
    if (screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
      const videoTrack = localStream.getVideoTracks()[0];
      replaceVideoTrack(videoTrack);
      isScreenSharing = false;
      shareBtn.textContent = 'Share Screen';
      log('Screen sharing stopped');
    }
  }

  leaveBtn.addEventListener('click', () => {
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
    if (screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
    }
    participants.forEach((participant) => {
      participant.peerConnection.close();
    });
    participants.clear();
    videoGrid.innerHTML = '';
    participantsList.innerHTML = '';
    roomInfo.style.display = 'none';
    document.querySelector('.waiting-message').style.display = 'block';
    if (socket) {
      socket.close();
    }
    log('Left the room');
    alert('You have left the room');
  });

  function generateUuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
</script>
</body></html>
