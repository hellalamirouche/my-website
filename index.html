
<html><head><base href="https://visio.ai/"><title>Visio AI - Secure P2P Video Conferencing</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    height: 100%;
    overflow: hidden;
  }
  .container {
    display: flex;
    height: 100vh;
  }
  .sidebar {
    width: 300px;
    background-color: #f3f2f1;
    padding: 20px;
    overflow-y: auto;
  }
  .main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  .video-grid {
    flex-grow: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    padding: 20px;
    background-color: #2f2f2f;
    overflow-y: auto;
  }
  .video-container {
    background-color: #1f1f1f;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    position: relative;
  }
  .video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .controls {
    display: flex;
    justify-content: center;
    padding: 20px;
    background-color: #f3f2f1;
  }
  .control-btn {
    margin: 0 10px;
    padding: 10px 20px;
    background-color: #464775;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .control-btn:hover {
    background-color: #5c5c8a;
  }
  .participant {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background-color: #fff;
    border-radius: 5px;
  }
  .participant-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    background-color: #464775;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .participant-name {
    font-weight: bold;
  }
  #joinForm {
    margin-bottom: 20px;
  }
  #joinForm input, #joinForm button {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
  }
  #joinForm button {
    background-color: #464775;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .waiting-message {
    text-align: center;
    color: #666;
    margin-top: 20px;
  }
  .name-label {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background-color: rgba(0,0,0,0.5);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>Participants</h2>
    <div id="joinForm">
      <input type="text" id="nameInput" placeholder="Enter your name">
      <input type="text" id="roomInput" placeholder="Enter room ID">
      <button onclick="joinMeeting()">Join Meeting</button>
    </div>
    <div id="participantsList"></div>
  </div>
  <div class="main-content">
    <div id="videoGrid" class="video-grid">
      <div class="waiting-message">
        <h3>Welcome to Visio AI</h3>
        <p>Enter your name and room ID, then click "Join Meeting" to start.</p>
        <p>Share the room ID with others to let them join the same meeting.</p>
      </div>
    </div>
    <div class="controls">
      <button class="control-btn" id="muteBtn">Mute</button>
      <button class="control-btn" id="videoBtn">Stop Video</button>
      <button class="control-btn" id="shareBtn">Share Screen</button>
      <button class="control-btn" id="leaveBtn">Leave Meeting</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script>
  const participants = [];
  const videoGrid = document.getElementById('videoGrid');
  const participantsList = document.getElementById('participantsList');
  const nameInput = document.getElementById('nameInput');
  const roomInput = document.getElementById('roomInput');
  const muteBtn = document.getElementById('muteBtn');
  const videoBtn = document.getElementById('videoBtn');
  const shareBtn = document.getElementById('shareBtn');
  const leaveBtn = document.getElementById('leaveBtn');

  let localStream;
  let screenStream;
  let isAudioMuted = false;
  let isVideoStopped = false;
  let isScreenSharing = false;
  let myPeer;
  let currentRoom;

  async function joinMeeting() {
    const name = nameInput.value.trim();
    const roomId = roomInput.value.trim();
    if (!name || !roomId) {
      alert('Please enter your name and room ID');
      return;
    }

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      setupLocalVideo(name, localStream);
      
      myPeer = new Peer();
      myPeer.on('open', (id) => {
        currentRoom = roomId;
        addParticipant(name, localStream, id);
        joinRoom(roomId, name, id);
      });

      myPeer.on('call', (call) => {
        call.answer(localStream);
        call.on('stream', (userVideoStream) => {
          addVideoElement(call.metadata.name, userVideoStream, call.peer);
        });
      });

      nameInput.value = '';
      roomInput.value = '';
      document.querySelector('.waiting-message').style.display = 'none';
    } catch (error) {
      console.error('Error accessing media devices:', error);
      alert('Failed to access camera and microphone. Please ensure you have given the necessary permissions.');
    }
  }

  function joinRoom(roomId, name, userId) {
    const socket = new WebSocket(`wss://visio.ai/room/${roomId}`);
    
    socket.onopen = () => {
      console.log('Connected to room');
      socket.send(JSON.stringify({ type: 'join', name, userId }));
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'user-connected') {
        connectToNewUser(data.userId, data.name);
      } else if (data.type === 'user-disconnected') {
        removeParticipant(data.userId);
      }
    };
  }

  function connectToNewUser(userId, name) {
    const call = myPeer.call(userId, localStream, { metadata: { name: nameInput.value } });
    call.on('stream', (userVideoStream) => {
      addVideoElement(name, userVideoStream, userId);
    });
  }

  function addParticipant(name, stream, id) {
    const participant = { name, stream, id };
    participants.push(participant);
    updateParticipantsList();
  }

  function removeParticipant(userId) {
    const index = participants.findIndex(p => p.id === userId);
    if (index !== -1) {
      participants.splice(index, 1);
      updateParticipantsList();
      const videoElement = document.getElementById(`video-${userId}`);
      if (videoElement) {
        videoElement.remove();
      }
    }
  }

  function updateParticipantsList() {
    participantsList.innerHTML = '';
    participants.forEach(participant => {
      const participantDiv = document.createElement('div');
      participantDiv.className = 'participant';
      participantDiv.innerHTML = `
        <div class="participant-avatar">${participant.name[0].toUpperCase()}</div>
        <span class="participant-name">${participant.name}</span>
      `;
      participantsList.appendChild(participantDiv);
    });
  }

  function addVideoElement(name, stream, userId) {
    const videoContainer = document.createElement('div');
    videoContainer.className = 'video-container';
    videoContainer.id = `video-${userId}`;
    const video = document.createElement('video');
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    const nameLabel = document.createElement('div');
    nameLabel.className = 'name-label';
    nameLabel.textContent = name;
    videoContainer.appendChild(video);
    videoContainer.appendChild(nameLabel);
    videoGrid.appendChild(videoContainer);
  }

  function setupLocalVideo(name, stream) {
    addVideoElement(name, stream, 'local');
    const localVideo = document.getElementById('video-local');
    if (localVideo) {
      localVideo.querySelector('video').muted = true;
    }
  }

  muteBtn.addEventListener('click', () => {
    isAudioMuted = !isAudioMuted;
    localStream.getAudioTracks()[0].enabled = !isAudioMuted;
    muteBtn.textContent = isAudioMuted ? 'Unmute' : 'Mute';
  });

  videoBtn.addEventListener('click', () => {
    isVideoStopped = !isVideoStopped;
    localStream.getVideoTracks()[0].enabled = !isVideoStopped;
    videoBtn.textContent = isVideoStopped ? 'Start Video' : 'Stop Video';
  });

  shareBtn.addEventListener('click', async () => {
    if (!isScreenSharing) {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const videoTrack = screenStream.getVideoTracks()[0];
        replaceVideoTrack(videoTrack);
        isScreenSharing = true;
        shareBtn.textContent = 'Stop Sharing';
        videoTrack.onended = stopScreenSharing;
      } catch (error) {
        console.error('Error sharing screen:', error);
        alert('Failed to share screen. Please ensure you have given the necessary permissions.');
      }
    } else {
      stopScreenSharing();
    }
  });

  function replaceVideoTrack(newTrack) {
    const videoSender = myPeer.connections.values().next().value[0].peerConnection
      .getSenders()
      .find(sender => sender.track.kind === 'video');
    videoSender.replaceTrack(newTrack);
    document.getElementById('video-local').querySelector('video').srcObject = new MediaStream([newTrack]);
  }

  function stopScreenSharing() {
    if (screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
      const videoTrack = localStream.getVideoTracks()[0];
      replaceVideoTrack(videoTrack);
      isScreenSharing = false;
      shareBtn.textContent = 'Share Screen';
    }
  }

  leaveBtn.addEventListener('click', () => {
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
    if (screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
    }
    if (myPeer) {
      myPeer.destroy();
    }
    videoGrid.innerHTML = '';
    participantsList.innerHTML = '';
    participants.length = 0;
    alert('You have left the meeting');
    document.querySelector('.waiting-message').style.display = 'block';
  });
</script>
</body></html>
